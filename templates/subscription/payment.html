{% extends "base.html" %}

{% block title %}Complete Payment - Lerzo{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white text-center">
                    <h4><i class="fas fa-credit-card me-2"></i>Complete Your Payment</h4>
                </div>
                
                <div class="card-body">
                    <div class="alert alert-info">
                        <h5 class="alert-heading">{{ plan['display_name'] }}</h5>
                        <p>
                            <strong>Amount:</strong> ₹{{ plan['amount_display'] }}<br>
                            <strong>Billing Cycle:</strong> {{ plan['duration'] }}
                        </p>
                        {% if plan_type == 'yearly' %}
                        <p class="mb-0">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            You're saving ₹1,389 compared to monthly payments!
                        </p>
                        {% endif %}
                    </div>
                    
                    <form id="paymentForm">
                        <div class="mb-3">
                            <label class="form-label">Payment Method</label>
                            <div class="border p-3 text-center rounded">
                                <i class="fab fa-cc-visa fa-2x me-2 text-primary"></i>
                                <i class="fab fa-cc-mastercard fa-2x me-2 text-danger"></i>
                                <i class="fab fa-cc-amex fa-2x me-2 text-info"></i>
                                <i class="fas fa-university fa-2x me-2 text-success"></i>
                                <p class="mt-2 mb-0 text-muted">Secure payment via Razorpay</p>
                            </div>
                        </div>
                        
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="termsCheck" required>
                           <label class="form-check-label" for="termsCheck">
    I agree to the 
    <a target="_blank" rel="noopener noreferrer" href="{{ url_for('terms_of_service') }}">Terms of Service</a>
    and 
    <a target="_blank" rel="noopener noreferrer" href="{{ url_for('privacy_policy') }}">Privacy Policy</a>
</label>


                        </div>
                        
                        <button type="button" id="rzp-button" class="btn btn-primary btn-lg w-100">
                            <i class="fas fa-lock me-2"></i> Pay Securely ₹{{ plan['amount_display'] }}
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
    var options = {
        "key": "{{ razorpay_key }}",
        "subscription_id": "{{ subscription.id }}",
        "name": "Lerzo",
        "description": "{{ plan['display_name'] }} Subscription",
        "image": "{% if current_user.logo_filename %}{{ url_for('static', filename='uploads/' + current_user.logo_filename) }}{% endif %}",
        "handler": function (response) {
            window.location.href = "{{ url_for('subscription_success') }}?payment_id=" + 
                                 response.razorpay_payment_id + 
                                 "&subscription_id={{ subscription.id }}" +
                                 "&plan={{ plan_type }}";
        },
        "prefill": {
            "name": "{{ current_user.name }}",
            "email": "{{ current_user.email }}",
            "contact": "{{ current_user.phone or '' }}"
        },
        "notes": {
            "centre_id": "{{ current_user.id }}",
            "plan_type": "{{ plan_type }}"
        },
        "theme": {
            "color": "#0d6efd"
        }
    };
    
    var rzp = new Razorpay(options);
    
    document.getElementById('rzp-button').onclick = function(e){
        if(!document.getElementById('termsCheck').checked) {
            alert('Please agree to the terms and conditions');
            return;
        }
        rzp.open();
        e.preventDefault();
    }
    
    rzp.on('payment.failed', function (response){
        alert('Payment failed. Please try again. Error: ' + response.error.description);
    });
</script>
{% endblock %}